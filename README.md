[![Build Status](https://magnum.travis-ci.com/brave/vault.svg?token=tEKWpRH3WZFkPWrgxB9T)](https://magnum.travis-ci.com/brave/vault)

# Brave Vault

A Personal Data Store for holding high-value user behavior with high privacy.


## Setup

Clone the repo: `git clone git@github.com:brave/vault.git`

Install dependencies with `npm install`

Install MongoDB: `brew update && brew install mongodb`

Start MongoDB. There are a variety of ways to do this, one option on a mac: `brew tap homebrew/services && brew services start mongodb`


## Configuration

For staging or production environments configuration variables are stored as environment preferences. See config/config.production.js for a list of these variables.

For local development you can copy config/config.development.js.tpl to config/config.development.js and define the local config variables.


## Running the server

Use `gulp` to run the server in development. This also sets up watchers and will restart the server on a file change.


## Design notes

[Intents](https://github.com/brave/vault/wiki/Intents)


## Theory of Operation
All operations are available via only HTTPS.
At a minimum,
all requests are logged with method, path, `Host` and `User-Agent` headers, client IP address,
and `sessionID` parameter (if present);
and all responses are logged with code and diagnostic(if any)
All HTTP content is `application/json`.
Commonly used data types are:

| data type   | syntax                                                           |
|-:|:-|
| `adUnitId`    | opaque string                                                  |
| `data`        | opaque string  (interpreted only by applications)              |
| `diagnostic`  | localized string intended for logging and human consumption    |
| `replacement` | string containing a (possibly) nested HTML tag                 |
| `stats`       | a [statistics summary](#statisticssummary) for the user's behavior                                          |
| `sessionId`   | opaque string                                                  |
| `tagName`     | string identifing an HTML tag (e.g., `'a'` for the `<a/>` tag) |
| `timestamp`   | number (usually integer) indicating the  number of milli-seconds since the UNIX epoch                       |
| `userId`      | [UUID version 4](https://en.wikipedia.org/wiki/Universally_unique_identifier#Version_4_.28random.29) string |

### Users and Sessions
Users are identified with a `userId` that is generated by the browser on initialization.
The user may enter the `userId` into another client in order to consolidate information.
The browser uses the `POST /v1/auth` operation to "make claim" to a `userId`.
The parameters are:

| parameter   | meaning                                                          |
|-:|:-|
| `userId`    | a value (previously) generated by the browser                    |
| `firstTime` | boolean indicating whether the `userId` should already exist     | 

The result of the operation is one of:

| code | payload      | meaning                                                  |
|-:|:-:|:-|
| 201  | `sessionID`  | `user` entry created (`firstTime=true`)                  |
| 200  | `sessionID`  | `user` entry retrieved (`firstTime=false`)               |
| 422  | `diagnostic` | `user entry` does not exist (`firstTime=false`)          |
| 422  | `diagnostic` | `user entry` already exists (`firstTime=true`)           |

On a successful creation:

* a `user` entry is stored in the database, along with a "persona" (not-identified) BTC wallet.

On either a succesful creation or retrieval:

* a `sessionID` is pseudo-randomly generated,
and stored in the database along with the corresponding `userID`, `User-Agent` header, and a creation timestamp.

All subsequent operations use the `sessionID` to identify the user and browser.

The browser uses the `DELETE /v1/session/{sessionId}` operation to mark the session as no longer active.
The result of the operation is one of:

| code | payload       | meaning                                                 |
|-:|:-:|:-|
| 200  | `stats`       | further use of this `sessionId` is not allowed          |
| 422  | `diagnostic`  | `sessionID` does not exist or is no longer active, etc. |

On a successful deletion,
the corresponding `session` entry is updated with an "no longer valid" timestamp (and not deleted).

#### Statistics Summary
A summary of the user's behavior is returned in the `stats` object.
At a minimum,
there are two properties present: `user` and `session`,
reporting aggregate properties for the `user`,
and the corresponding properties for the `sessionId`, e.g.,

        { user    : { replacements: 10 }
        , session : { replacements: 10 }
        }

The properties in common for these two top-level properties are:

| parameter   | meaning                                                          |
|-:|:-|
| `replacements` | the integer-valued number of advertisements replaced          |

### Recording Intentions
The browser uses the 'POST /intents' operation to indicate that the user is clicking on a link,
a page is loading,
or a page is unloading.
The parameters are:

| parameter   | meaning                                                          |
|-:|:-|
| `sessionId` | from the corresponding `/auth` operation                         |
| `action`    | one of: 'click', 'enter', 'exit', or 'error'                     |
| `url`       | the URL associated with the action                               |
| `timestamp` | when the browser took the `action`                               |

**Q: is the document [Intents](https://github.com/brave/vault/wiki/Intents) desired or OBE?**

The result of the operation is:

| code | payload      | meaning                                                  |
|-:|:-:|:-|
| 200  | `stats`      | intents recorded                                         |
| 422  | `diagnostic` | `sessionID` does not exist or is no longer active, etc.  |

### Replacing Advertisements
The browser uses the `GET /v1/ad/{sessionId}` operation to get information on how to perform a replacement.
The parameters are:

| parameter   | meaning                                                          |
|-:|:-|
| `sessionId` | from the corresponding `/auth` operation                         |
| `tagName`   | at present, 'a' (for the `<a/>` tag)                             |
| `width`     | the pixel width of the replacement advertisement                 |
| `height`    | the pixel height of the replacement advertisement                |

The result of the operation is:

| code | payload      | meaning                                                  |
|-:|:-:|:-|
| 200  | `replacement`| a replacement for the `<a/>` tag in the page             |
| 404  |              | `sessionID` does not exist or is no longer active, etc. |

**Q: a `301` redirect is no longer returned. Is that OK?**

The `replacement` parameter has the form:

        <a href='https://.../ad-click/{adUnitId}'><img src='...' /></a>

If the user clicks on this `<a/>` tag,
then in addition to (automatically) using the `POST /v1/intents` operation to record the 'click',
the brower also uses the `GET /v1/ad-click/:adUnitId` operation.
The result of the operation is:

| code | payload      | meaning                                                  |
|-:|:-:|:-|
| 301  |              | `Location` header redirects to advertiser's site         |
| 404  |              | `adUnitId` does not exist                                |

### Synchronizing Clients
Applications may use an _advisory_ locking scheme in order to synchornize shared information.

The browser uses the `GET /v1/sync/:sessionID` operation to retrieve information shared between all applications using the
corresponding `userId`.
The result of the operation is one of:

| code | payload       | meaning                                                 |
|-:|:-:|:-|
| 200  | `timestamp`   | the current timestamp of the data stored                |
|      | `data`        | a string containing the data                            |
| 404  |               | `sessionID` does not exist or is no longer active, etc. |

The `data` object is opaque to the server -- the applications are responsible for determining the syntax and semantics,
along with the encoding of the information.
If no information has been previously stored for the corresponding `userId`,
the empty string (`''`) is returned.

The browser uses the `PUT /v1/sync/:sessionID` operation to update information shared between all applications using the
corresponding `sessionId`.
The parameters are:

| parameter   | meaning                                                          |
|-:|:-|
| `timestamp`  | the timestamp associated with the `data`                        |
| `data`       | a string containing the new value                               |

The result of the operation is one of:

| code | payload       | meaning                                                 |
|-:|:-:|:-|
| 200  | `timestamp`   | the current timestamp of the `data` stored              |
| 422  | `diagnostic`  | `sessionID` does not exist or is no longer active, etc. |
|      |               | `timestamp` parameter does not match the last timestamp |

Accordingly,
to successfully update the shared information,
the browser must:

- use the `GET /v1/sync/:sessionID` operation to retrieve the current information; then,
- modify the returned `data` as appropriate; then,
- use the `PUT /v1/sync/:sessionID`' operation with the returned `timestamp` and modified `data`

This allows multiple applications to (patiently) coordinate their actions in upading the shared information.
However,
if an application *must* unilaterally overwrite the shared information,
it omits the `timestamp` parameter to the `PUT /v1/sync/:sessionID` operation.

### Management operations
**Q: `/ad-manifest ?**

## Practice of Operation
**TBD.**

### Database usage

### Bitcoin wallet provisioning

### Advertisement provisioning

