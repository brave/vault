[![Build Status](https://magnum.travis-ci.com/brave/vault.svg?token=tEKWpRH3WZFkPWrgxB9T)](https://magnum.travis-ci.com/brave/vault)

# Brave Vault

A Personal Data Store for holding high-value user behavior with high privacy.


## Setup

Clone the repo: `git clone git@github.com:brave/vault.git`

Install dependencies with `npm install`

Install MongoDB: `brew update && brew install mongodb`

Start MongoDB. There are a variety of ways to do this, one option on a mac: `brew tap homebrew/services && brew services start mongodb`

## StandardJS

For linting we use [StandardJS](https://github.com/feross/standard). It's recommended that you install the necessary IDE plugin. Since this repo uses ES7 features, you'll need a global install of both the standard and babel-eslint packages.

## Configuration

For staging or production environments configuration variables are stored as environment preferences. See config/config.production.js for a list of these variables.

For local development you can copy config/config.development.js.tpl to config/config.development.js and define the local config variables.


## Running the server

Use `gulp` to run the server in development. This also sets up watchers and will restart the server on a file change.


## Theory of Operation
All operations are available via only HTTPS on public-facing systems.
At a minimum,
all requests are logged with method, path, `Host` and `User-Agent` headers, client IP address,
and `sessionId` parameter (if present);
and all responses are logged with code and diagnostic(if any)
All HTTP content is `application/json`.
Commonly used data types are:

| data type     | syntax                                                                                                      |
| -------------:|:----------------------------------------------------------------------------------------------------------- |
| `adUnitId`    | opaque string                                                                                               |
| `data`        | opaque string  (interpreted only by applications)                                                           |
| `diagnostic`  | localized string intended for logging and human consumption                                                 |
| `replacement` | string containing a (possibly) nested HTML tag                                                              |
| `stats`       | a [statistics summary](#statisticssummary) for the user's behavior                                          |
| `userId`      | [UUID v4](https://en.wikipedia.org/wiki/Universally_unique_identifier#Version_4_.28random.29) string        |
| `tagName`     | string identifing an HTML tag (e.g., `'iframe'` for the `<iframe/>` tag)                                    |
| `timestamp`   | opaque string identifying a unique instance of time                                                         |
| `userId`      | [UUID v4](https://en.wikipedia.org/wiki/Universally_unique_identifier#Version_4_.28random.29) string        |

Errors are "boomlets", e.g.,

        {
          "statusCode": 420,
          "error": "Enhance Your Calm",
          "message": "Your repeated violations of the Verbal Morality Statue ..."
        }

Visit the docs here: http://vault-staging.brave.com/documentation

### Users and Sessions
Users are identified with a `userId` that is generated by the browser on initialization.
The user may enter the `userId` into another client in order to consolidate information.
To register a `userId` with the server,
the browser uses the `PUT /v1/users/{userId}` operation.

The result of the operation is one of:

| code | payload      | meaning                                                  |
| ----:|:------------:|:-------------------------------------------------------- |
| 201  |              | `user` entry created                                     |
| 422  | `boomlet`    | `user entry` already exists                              |

Once a `userId` is successfully registered,
the browser generates (as often as it wishes) a `sessionId` that is used as a parameter for subsequent operations,
in order to identify both the user and browser session.

Optionally,
the browser uses the `DELETE /v1/users/{userId}/sessions/{sessionId}` operation to mark the session as no longer active.
The result of the operation is one of:

| code | payload      | meaning                                                  |
| ----:|:------------:|:-------------------------------------------------------- |
| 200  | `stats`      | further use of this `sessionId` is not allowed           |
| 404  | `boomlet`    | `userId` does not refer to an existing user              |

On a successful operation,
the corresponding `session` entry is considered "no longer valid".
If a `sessionId` is not referenced in a timely-fashion,
the server may choose to invalidate it.

Regardless of a successful operation or an implicit invalidation,
the `sessionId` may no longer be used to perform new operations.

#### Statistics Summary
A summary of the user's behavior is returned in the `stats` object.
At a minimum,
only one property is returned:

| parameter      | meaning                                                       |
| --------------:|:------------------------------------------------------------- |
| `replacements` | the integer-valued number of advertisements replaced          |

### Synchronizing Applications
Applications use an _advisory locking_ scheme in order to synchronize and persist shared information.

The browser uses the `GET /v1/users/{userId}/appState` operation to retrieve information shared between all applications for
the corresponding user.
The result of the operation is one of:

| code | payload      | meaning                                                 |
| ----:|:------------:|:-------------------------------------------------------- |
| 200  | `timestamp`  | an opaque string identifying the stored state            |
|      | `payload`    | an opaque JSON object                                    |
| 404  | `boomlet`    | `userId` does not refer to an existing user              |

The `payload` object is opaque to the server -- the applications are responsible for determining the syntax and semantics
of the information.
If no information has been previously stored for the corresponding `userId`,
the empty object (`{}`) is returned.

The browser uses the `PUT /v1/users/{userId}/appState` operation to update information shared between all applications for
the corresponding user.
The parameters are:

| parameter   | meaning                                                          |
| -----------:|:---------------------------------------------------------------- |
| `timestamp`  | an opaque string identifying the stored state                   |
| `payload`    | an opaque JSON object                                           |

The result of the operation is one of:

| code | payload       | meaning                                                                |
| ----:|:------------:|:----------------------------------------------------------------------- |
| 200  | `timestamp`   | an opaque string identifying the `payload` stored                      |
| 404  | `boomlet`     | `userId` does not refer to an existing user                            |
| 422  | `boomlet`     | `timestamp` parameter does not match the timestamp of the stored state |

Accordingly,
to successfully update the shared information,
the browser must:

1. use the `GET /v1/users/{userId}/appState` operation to retrieve the current information; then,
2. modify the returned `payload` as appropriate; then,
3. use the `PUT /v1/users/{userId}/appState`' operation with the previously-returned `timestamp` and the modified `payload`
4. if a `422` is returned, go back to Step 1; otherwise,
5. optionally: locally persist the newly-returned returned `timestamp`and the modified `payload`,
so as to skip Step 1 the next time a state update is desired.

This allows multiple applications to (patiently) coordinate their actions in upading the shared information.
However,
if an application *must* unilaterally overwrite the shared information,
it omits the `timestamp` parameter to the `PUT /v1/users/{userId}/appState` operation.

### Ad Manifest operations
The Ad Manifest subsystem maintains a repository of ad placement information for different sites.

The administrator uses the `GET /v1/ad-manifest` operation to incrementally get information about sites.
The parameters are:

| parameter   | meaning                                                                     |
| -----------:|:--------------------------------------------------------------------------- |
| `id`        | the database identifier of the first entry to return                        |
| `since`     | string, an opaque monotonically-increasing value                            |
| `limit`     | positive integer, the maximum number of entries to return                   |

Either the `id` or `since` entry must be present, but not both.
If the `id` parameter is present, then the `limit` parameter defaults to `1`.
If the `id` parameter is not present, the the `since` parameter defaults to `0` and the `limit` parameter defaults to `100`.

The result of the operation is a JSON array containing zero or more entries.
Each entry is an object with these attributes:

| attribute       | meaning                                                                    |
| ---------------:|:-------------------------------------------------------------------------- |
| `_id`           | string, a unique identifier for the entry                                  |
| `hostname`      | string, a domain name corresponding to the entry                           |
| `replacementAd` | an array of objects                                                        |
| `timestamp`     | string, an opaque value uniquely identifying the entry's modification time |


The administrator uses the `GET /v1/ad-manifest/{hostname} operation to get information on the entry corresponding to a
particular hostname. The result of the oepration is a JSON object.

The administrator uses the `POST /v1/ad-manifest` operation to create an entry.
The parameters are:

| parameter      | meaning                                                                     |
| ---------------:|:-------------------------------------------------------------------------- |
| `hostname`      | string, a domain name corresponding to the entry                           |
| `replacementAd` | an array of objects                                                        |

Similarly, the administrator uses the `PUT /v1/ad-manifest/{hostname}` opreation to modify an entry.
The parameters are:

| parameter      | meaning                                                                     |
| ---------------:|:-------------------------------------------------------------------------- |
| `replacementAd` | an array of objects                                                        |

### OIP statistic operations
The OIP subsystem attempts to do "just in time" caching of advertisements.
These are used when performing the `/v1/users/{userId}/replacement` operation.
Each of the statistics operations takes an optional `format` parameter that defaults to `false`.
If set to `true` then instead of returning `application/json`, `text/html` is returned.

The operator uses the `GET /v1/oip/ads/categories` operation to get information about all advertising categories known
to the server.
The parameters are:

| parameter   | meaning                                                                |
| -----------:|:---------------------------------------------------------------------- |
| `compress`  | boolean, whether information on empty categories should be returned    |
| `format`    | boolean, whether the results should be formatted for human-readability |

The result of the operation is a JSON object containing information about each category.
Each category is an object with these attributes:

| attribute   | meaning                                                                |
| -----------:|:---------------------------------------------------------------------- |
| `name`      | string, textual name of the category                                   |
| `errors`    | integer, the number of times a retrieval resulted in a network error   |
| `intents`   | array of strings, the keywords associated with this category           |
| `sizes`     | array of objects, for each ad size associated with the category        |

Each size is an object with these attributes:

| attribute     | meaning                                                              |
| -------------:|:-------------------------------------------------------------------- |
| `empties`     | integer, the number of times a retrieval resulted in an empty result |
| `queue`       | integer, the number of ads in the queue for this size                |
| `retryIn`     | timestamp, when the next retrieval for this size will occur          |
| `impressions` | integer, the number of impressions remaining for this size           |
| `earliest`    | timestamp, the earliest expiration date for this size                |
| `latest`      | timestamp, the latest expiration date for this size                  |

If `format` is `true`, then timestamps are returned in _relative_ seconds;
otherwise, they are returned in the number of milliseconds since the UNIX epoch.

The operator uses the `GET /v1/oip/ads/categories/{category}` to get information about a particular advertising category.
The parameters are:

| parameter   | meaning                                                                |
| -----------:|:---------------------------------------------------------------------- |
| `category`  | string, the desired category, e.g., "IAB1"                             |
| `format`    | boolean, whether the results should be formatted for human-readability |

The result of the operation is a JSON object containing information about the desired category.

The operator uses the `/v1/oip/ads/statistics` operation to get high-level information about the categories and sizes in the
system.
The parameters are:

| parameter   | meaning                                                                |
| -----------:|:---------------------------------------------------------------------- |
| `format`    | boolean, whether the results should be formatted for human-readability |

The result of the operation is a JSON object containing these attributes:

| attribute    | meaning                                                                |
| ------------:|:---------------------------------------------------------------------- |
| `uptime`     | timestamp, when the OIP subsystem started                              |
| `categories` | an object containing `active` and `total` attributes                   |
| `errors`     | integer, the total number of errors encountered during retrievals      |
| `options`    | an object listing the tuning parameters for the OIP subsystem          |
| `sizes`      | array of objects, containing `empties`, `impressions`, and `queue`     |

